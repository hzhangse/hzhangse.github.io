<!--?xml version="1.0" encoding="UTF-8" standalone="yes"?-->

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="exporter-version" content="Evernote Mac 9.5.5 (463961)">

<meta name="author" content="Ryan">

<meta name="created" content="2021-07-22 06:24:20 +0000">

<meta name="updated" content="2021-07-22 06:27:15 +0000">

<title>Zeus: Uber 开发的分布式的高扩展 Shuffle 服务组件</title>

<div><br clear="none"></div>

<div><div><div><div><div><div><div><p>Uber 作为全球性的一家公司，到目前完成了150亿次旅行订单，到目前每天1800万人次旅行订单。覆盖六大洲，69个国家和10000个城市，1.03亿月活跃用户，500万活跃的司机，全球22000名员工，其中包含3700名开发者。</p><p><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/AB8EDDD5-10B1-40BB-BAFF-E5C266FC58B4.png" height="998" width="1802"><br clear="none">数据和机器学习算法是 Uber 的基石，在 Uber 里面有大量的数据和 ML 相关的场景，主要包括以下这些：</p><p><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/DC9C4E40-5A6C-478F-BA03-2A5FBBFC5A66.png" height="892" width="1680"><br clear="none">由于时间的限制，这次分享主要挑几个主要的介绍。其中一个就是 ETAs（预计到达时间），ETAs 是 Uber 一个非常重要的案例。</p><p><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/5B3CFDF9-1C79-4F57-B666-2ED9F301D5FE.png" height="920" width="1722"><br clear="none">下面一些是其他的场景</p><p><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/04E4A0C7-3133-4A4F-BCB8-C66D61AD1E9D.png" height="926" width="1604"><br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/B849F03C-B7C2-47C4-84C2-0CA0F5816D16.png" height="930" width="1766"><br clear="none">下面是 Uber 的大数据技术栈<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/24AB6FDC-7372-4D11-9563-853D4482893A.png" height="976" width="1774"><br clear="none">可以看到，基本上和其他公司的大数据技术栈大同小异。下面是 Uber 的 ML 技术栈。<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/354392F6-E2DB-4621-A772-B5F6F913AED9.png" height="962" width="1644"></p><h3><a shape="rect" target="_blank">Uber Apache Spark 使用情况</a></h3><p><a shape="rect" target="_blank">在 Uber，Apache Spark 是主要的分析执行引擎。</a></p><p><a shape="rect" target="_blank">•95% 的批处理和 ML 作业在 Spark 上运行<br clear="none">•Spark 是运行在 YARN 和 Peloton/Mesos 上<br clear="none">•Spark 的 Shuffle 数据是使用外部 Shuffle 服务的<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/408A0BE9-B9C9-49DC-85AA-570B4B434076.png" height="952" width="1416"><br clear="none">下图是 Apache Spark Shuffle 服务工作原理：Spark 的 Mapper 端把数据写到本地磁盘，并且按照分区分组好写到同一个文件中；同时在另外一个文件里面维持对应的索引。Reduce 端通过 Shuffle Reader 访问 Mapper 端的 Local Shuffle Service 获取其对应的分区数据。在 Reduce 端根据数据量的大小可能会把数据 Spill 到<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/408A0BE9-B9C9-49DC-85AA-570B4B434076.png" height="952" width="1416"><br clear="none">Apache Spark Shuffle 服务的极限：<br clear="none">•可能耗尽 SDD 的磁盘空间<br clear="none">•可靠性问题<br clear="none">•Kubernetes 动态分配<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/710C94E1-E388-4992-8C65-5C914FE869E2.png" height="498" width="1310"><br clear="none">针对上面的问题，有很多不同的应对方法：</a></p><p><a shape="rect" target="_blank">方法一：把 Shuffle 的数据写到外部存储系统。</a></p><p><a shape="rect" target="_blank">比如同步写到 NFS 上，但是性能会慢2倍；同步写到 HDFS 上，性能会慢5倍。</a></p><p><a shape="rect" target="_blank"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/70ED204C-E451-48D7-B229-DB4F49E46EA4.png" height="746" width="986"><br clear="none">如果是半异步写，HDFS慢4倍左右</a></p><p><a shape="rect" target="_blank"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/98E365C2-44B4-487A-90EE-B9CB70FE93A2.png" height="544" width="964"><br clear="none">方法二：使用远程 Shuffle 服务。<br clear="none">•流式的方式写到 HDFS 上，这个会比直接写到本地存储慢 1.5 倍；<br clear="none">•流式的方式写到本地，和 external shuffle service 性能类似。</a></p><p><a shape="rect" target="_blank"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/4CE42588-2004-4986-8B7A-29C684BE5D04.png" height="622" width="1302"><br clear="none">流式的方式写到本地存储，这种方式改变了 MapReduce 的模式，流程主要为 Record Stream -&gt; Shuffle Server -&gt; Disk，好处是在 Executor 端没有临时的 spill 文件。<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/6CA36EF0-9B83-4990-B59F-FE53CA7A49A1.png" height="606" width="1160"><br clear="none">下图就是远程 Spark Shuffle 服务的架构<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/F5F0B8DF-8DD8-4A80-82EA-7029C94C44D5.png" height="966" width="1382"></a></p><h3><a shape="rect" target="_blank">深入了解远程 Shuffle 服务</a></h3><h3><a shape="rect" target="_blank">Zeus 设计原理</a></h3><p><a shape="rect" target="_blank">•能够水平扩展。每个服务实例都独立工作；避免中心化的状态或者存储；<br clear="none">•解决网络延迟。主要包括减少服务器响应的等待时间以及流式数据的写法；<br clear="none">•性能优化。Uber 内部大多数 Spark 应用程序已针对性进行了性能优化；同时，性能优化依靠了 YARN / Apache Spark 的重试进行故障恢复<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/89423EA4-F823-4348-B416-18ECAF805BC9.png" height="910" width="1336"><br clear="none">下面分别对这三方面进行详细的介绍。</a></p><h3><a shape="rect" target="_blank">水平扩展</a></h3><p><a shape="rect" target="_blank">水平扩展主要包括以下方面<br clear="none">•Spark应用程序共享或者使用不同的 shuffle servers<br clear="none">•Shuffle 服务器之间没有共享状态<br clear="none">•Shuffle 服务器可扩展<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/AFE714C4-99D5-44B7-801C-E9219DBCAA77.png" height="472" width="1266"><br clear="none">下面是一个 Shuffle 服务的分布式架构图<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/C63C19CA-EF18-4A5A-86CA-ACD29B2A3EDE.png" height="888" width="1770"><br clear="none">假设我们的 Mapper 个数为 m， Reduce 个数为 r，Shuffle 服务器的个数为 s，那么 Mapper 的网络连接数为 m * s；Reduce 的网络连接数为 r。<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/A6D6354C-82E7-4502-8DD5-8DCAEA91AC69.png" height="710" width="1228"></a></p><h3><a shape="rect" target="_blank">网络延迟</a></h3><p><a shape="rect" target="_blank">网络延迟解决主要包括服务器端使用了 Netty，两个线程组以及二进制网络协议。<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/FD7CAA48-0AA1-416E-8A97-F66C1A967348.png" height="882" width="1414"><br clear="none">还包括直接读写磁盘文件。比如直接将数据写到 OS 文件；使用零复制技术；顺序读写。<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/0E4CD212-7938-4EDA-A5BE-DA4D3D107E8E.png" height="754" width="1622"><br clear="none">客户端使用到压缩<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/F722222D-9FE2-4C11-B03F-90A5544C4B9B.png" height="706" width="1350"><br clear="none">并行系列化和网络 IO<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/D024E28B-125F-4F17-B65B-1395A1CBCBC1.png" height="454" width="1192"><br clear="none">访问连接池<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/34440231-72CB-4D66-83C1-37BF9A33D99F.png" height="368" width="892"></a></p><h3><a shape="rect" target="_blank">性能优化</a></h3><p><a shape="rect" target="_blank">性能方面主要包括异步 Shuffle 数据提交<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/5D09F454-06A0-4A60-8E31-8194AA963799.png" height="592" width="1358"></a></p><h3><a shape="rect" target="_blank">Zeus 容错实现</a></h3><p><a shape="rect" target="_blank">Zeus 的 Shuffle 服务发现和健康检测使用到了 Zookeeper。<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/E34B038B-0316-48E7-90B8-0652747B506D.png" height="694" width="1488"><br clear="none">同时 Shuffle 数据进行了复制。<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/42E65767-E5D9-45A7-929B-9111EF403A3A.png" height="798" width="1672"></a></p><h3><a shape="rect" target="_blank">Zeus 生产使用</a></h3><p><a shape="rect" target="_blank">Zeus 和开源的 Apache Spark 兼容。可以直接通过 Shuffle 插件机制来启用。<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/0F086A12-2628-4E89-999B-71FE83465C63.png" height="700" width="1574"><br clear="none">Zeus 的监控使用了 Uber 开源的 M3 metrics library。核心的监控指标包括网络连接数、文件描述符数以及磁盘利用率。<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/C6895BCC-9C2F-4A61-9FA4-1EAC2A6C934B.png" height="636" width="1028"><br clear="none">测试策略主要包括单元测试、随机测试以及生产查询抽样。<br clear="none"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/1B55C371-7CF3-4347-A48D-188171767C97.png" height="438" width="790"><br clear="none">下面是 Uber 内部 Zeus 的生产情况：<br clear="none">•在生产环境使用了八个多月；<br clear="none">•每天承载数千个应用程序；<br clear="none">•作业延迟与 external shuffle 相当；<br clear="none">•马上将开源</a></p><p><a shape="rect" target="_blank"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/15AE843B-B4C6-462D-8BD4-5D3BEE73A39F.png" height="864" width="1730"><br clear="none">Zeus 的展望如下<br clear="none">•支持所有的 Spark 工作负载，包括 Hive on Spark<br clear="none">•支持多租户；<br clear="none">•支持负载均衡；<br clear="none">•兼容 Spark Shuffle metadata API</a></p><p><a shape="rect" target="_blank"><img src="Zeus%3A%20Uber%20%E5%BC%80%E5%8F%91%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E9%AB%98%E6%89%A9%E5%B1%95%20Shuffle%20%E6%9C%8D%E5%8A%A1%E7%BB%84%E4%BB%B6.resources/AE1D74B4-157B-468B-A547-DE72139A0F9B.png" height="580" width="1306"></a></p><p><a shape="rect" target="_blank"><br clear="none"></a></p></div></div></div></div></div></div></div>

